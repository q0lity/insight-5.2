{
  "file_path": "apps/desktop/src/assistant/storage.ts",
  "main_branch_history": [],
  "task_views": {
    "007-so-on-the-engine-right-here-where-i-chat-so-here-l": {
      "task_id": "007-so-on-the-engine-right-here-where-i-chat-so-here-l",
      "branch_point": {
        "commit_hash": "223b6906c6e567162b9c4367984c6ffbc6ed28e6",
        "content": "export type AssistantMode = 'local' | 'llm' | 'hybrid'\n\nexport type ChatMessageRole = 'user' | 'assistant'\n\nexport type ChatMessage = {\n  id: string\n  role: ChatMessageRole\n  content: string\n  createdAt: number\n}\n\nexport type WeightUnit = 'lbs' | 'kg'\nexport type DistanceUnit = 'mi' | 'km'\n\n// Available AI models for nutrition/workout estimation\nexport const AI_MODELS = [\n  { id: 'gpt-4o-mini', name: 'GPT-4o Mini', description: 'Fast, cheaper' },\n  { id: 'gpt-4o', name: 'GPT-4o', description: 'More accurate' },\n  { id: 'gpt-4.1', name: 'GPT-4.1', description: 'Latest' },\n  { id: 'gpt-4.1-mini', name: 'GPT-4.1 Mini', description: 'Fast, balanced' },\n] as const\n\nexport type AssistantSettings = {\n  mode: AssistantMode\n  openAiKey?: string\n  chatModel?: string\n  parseModel?: string\n  // Nutrition/workout estimation model (can be different from parseModel)\n  nutritionModel?: string\n  // User preferences for health tracking\n  preferredWeightUnit?: WeightUnit\n  preferredDistanceUnit?: DistanceUnit\n}\n\nconst CHAT_KEY = 'insight5.assistant.chat.v1'\nconst SETTINGS_KEY = 'insight5.assistant.settings.v1'\nexport const ASSISTANT_SETTINGS_CHANGED_EVENT = 'insight5.assistant.settings.changed'\n\nconst DEFAULT_CHAT_MODEL = 'gpt-4o-mini'\nconst DEFAULT_PARSE_MODEL = 'gpt-4o-mini'\nconst DEFAULT_NUTRITION_MODEL = 'gpt-4o-mini'\nconst DEFAULT_WEIGHT_UNIT: WeightUnit = 'lbs'\nconst DEFAULT_DISTANCE_UNIT: DistanceUnit = 'mi'\nconst DEFAULT_MODE: AssistantMode = 'hybrid'\n\nfunction makeId() {\n  return `${Date.now()}_${Math.random().toString(16).slice(2)}`\n}\n\nexport function loadChat(): ChatMessage[] {\n  try {\n    const raw = localStorage.getItem(CHAT_KEY)\n    if (!raw) return []\n    const parsed = JSON.parse(raw) as ChatMessage[]\n    return Array.isArray(parsed) ? parsed.sort((a, b) => a.createdAt - b.createdAt) : []\n  } catch {\n    return []\n  }\n}\n\nexport function saveChat(messages: ChatMessage[]) {\n  localStorage.setItem(CHAT_KEY, JSON.stringify(messages))\n}\n\nexport function appendChatMessage(messages: ChatMessage[], message: Omit<ChatMessage, 'id' | 'createdAt'> & Partial<Pick<ChatMessage, 'id' | 'createdAt'>>) {\n  const next: ChatMessage = {\n    id: message.id ?? makeId(),\n    createdAt: message.createdAt ?? Date.now(),\n    role: message.role,\n    content: message.content,\n  }\n  const updated = [...messages, next]\n  saveChat(updated)\n  return updated\n}\n\nconst DEFAULT_SETTINGS: AssistantSettings = {\n  mode: DEFAULT_MODE,\n  chatModel: DEFAULT_CHAT_MODEL,\n  parseModel: DEFAULT_PARSE_MODEL,\n  nutritionModel: DEFAULT_NUTRITION_MODEL,\n  preferredWeightUnit: DEFAULT_WEIGHT_UNIT,\n  preferredDistanceUnit: DEFAULT_DISTANCE_UNIT,\n}\n\nexport function loadSettings(): AssistantSettings {\n  try {\n    const raw = localStorage.getItem(SETTINGS_KEY)\n    if (!raw) return { ...DEFAULT_SETTINGS }\n    const parsed = JSON.parse(raw) as AssistantSettings\n    if (!parsed?.mode) return { ...DEFAULT_SETTINGS }\n    const normalizedMode = parsed.mode\n    const mode: AssistantMode =\n      normalizedMode === 'local' || normalizedMode === 'hybrid' || normalizedMode === 'llm'\n        ? normalizedMode\n        : DEFAULT_MODE\n    return {\n      mode,\n      openAiKey: parsed.openAiKey,\n      chatModel: parsed.chatModel ?? DEFAULT_CHAT_MODEL,\n      parseModel: parsed.parseModel ?? parsed.chatModel ?? DEFAULT_PARSE_MODEL,\n      nutritionModel: parsed.nutritionModel ?? DEFAULT_NUTRITION_MODEL,\n      preferredWeightUnit: parsed.preferredWeightUnit ?? DEFAULT_WEIGHT_UNIT,\n      preferredDistanceUnit: parsed.preferredDistanceUnit ?? DEFAULT_DISTANCE_UNIT,\n    }\n  } catch {\n    return { ...DEFAULT_SETTINGS }\n  }\n}\n\nexport function saveSettings(settings: AssistantSettings) {\n  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings))\n  try {\n    window.dispatchEvent(new Event(ASSISTANT_SETTINGS_CHANGED_EVENT))\n  } catch {\n    // ignore\n  }\n}\n",
        "timestamp": "2026-01-13T12:35:10.658231"
      },
      "worktree_state": {
        "content": "export type AssistantMode = 'local' | 'llm' | 'hybrid'\n\nexport type ChatMessageRole = 'user' | 'assistant'\n\n// Attachment type for images and documents in chat messages\nexport type ChatAttachmentType = 'image' | 'pdf'\n\nexport type ChatAttachment = {\n  id: string\n  type: ChatAttachmentType\n  name: string\n  // Base64-encoded data with MIME prefix (e.g., data:image/jpeg;base64,...)\n  data: string\n  // Original file size in bytes\n  size: number\n  // MIME type (e.g., image/png, application/pdf)\n  mimeType: string\n}\n\nexport type ChatMessage = {\n  id: string\n  role: ChatMessageRole\n  content: string\n  createdAt: number\n  // Optional attachments (images, PDFs) for multi-modal messages\n  attachments?: ChatAttachment[]\n}\n\nexport type WeightUnit = 'lbs' | 'kg'\nexport type DistanceUnit = 'mi' | 'km'\n\n// Available AI models for nutrition/workout estimation\nexport const AI_MODELS = [\n  { id: 'gpt-4o-mini', name: 'GPT-4o Mini', description: 'Fast, cheaper' },\n  { id: 'gpt-4o', name: 'GPT-4o', description: 'More accurate' },\n  { id: 'gpt-4.1', name: 'GPT-4.1', description: 'Latest' },\n  { id: 'gpt-4.1-mini', name: 'GPT-4.1 Mini', description: 'Fast, balanced' },\n] as const\n\nexport type AssistantSettings = {\n  mode: AssistantMode\n  openAiKey?: string\n  chatModel?: string\n  parseModel?: string\n  // Nutrition/workout estimation model (can be different from parseModel)\n  nutritionModel?: string\n  // User preferences for health tracking\n  preferredWeightUnit?: WeightUnit\n  preferredDistanceUnit?: DistanceUnit\n}\n\nconst CHAT_KEY = 'insight5.assistant.chat.v1'\nconst SETTINGS_KEY = 'insight5.assistant.settings.v1'\nexport const ASSISTANT_SETTINGS_CHANGED_EVENT = 'insight5.assistant.settings.changed'\n\nconst DEFAULT_CHAT_MODEL = 'gpt-4o-mini'\nconst DEFAULT_PARSE_MODEL = 'gpt-4o-mini'\nconst DEFAULT_NUTRITION_MODEL = 'gpt-4o-mini'\nconst DEFAULT_WEIGHT_UNIT: WeightUnit = 'lbs'\nconst DEFAULT_DISTANCE_UNIT: DistanceUnit = 'mi'\nconst DEFAULT_MODE: AssistantMode = 'hybrid'\n\nfunction makeId() {\n  return `${Date.now()}_${Math.random().toString(16).slice(2)}`\n}\n\nexport function loadChat(): ChatMessage[] {\n  try {\n    const raw = localStorage.getItem(CHAT_KEY)\n    if (!raw) return []\n    const parsed = JSON.parse(raw) as ChatMessage[]\n    return Array.isArray(parsed) ? parsed.sort((a, b) => a.createdAt - b.createdAt) : []\n  } catch {\n    return []\n  }\n}\n\nexport function saveChat(messages: ChatMessage[]) {\n  localStorage.setItem(CHAT_KEY, JSON.stringify(messages))\n}\n\nexport function appendChatMessage(messages: ChatMessage[], message: Omit<ChatMessage, 'id' | 'createdAt'> & Partial<Pick<ChatMessage, 'id' | 'createdAt'>>) {\n  const next: ChatMessage = {\n    id: message.id ?? makeId(),\n    createdAt: message.createdAt ?? Date.now(),\n    role: message.role,\n    content: message.content,\n    attachments: message.attachments,\n  }\n  const updated = [...messages, next]\n  saveChat(updated)\n  return updated\n}\n\nconst DEFAULT_SETTINGS: AssistantSettings = {\n  mode: DEFAULT_MODE,\n  chatModel: DEFAULT_CHAT_MODEL,\n  parseModel: DEFAULT_PARSE_MODEL,\n  nutritionModel: DEFAULT_NUTRITION_MODEL,\n  preferredWeightUnit: DEFAULT_WEIGHT_UNIT,\n  preferredDistanceUnit: DEFAULT_DISTANCE_UNIT,\n}\n\nexport function loadSettings(): AssistantSettings {\n  try {\n    const raw = localStorage.getItem(SETTINGS_KEY)\n    if (!raw) return { ...DEFAULT_SETTINGS }\n    const parsed = JSON.parse(raw) as AssistantSettings\n    if (!parsed?.mode) return { ...DEFAULT_SETTINGS }\n    const normalizedMode = parsed.mode\n    const mode: AssistantMode =\n      normalizedMode === 'local' || normalizedMode === 'hybrid' || normalizedMode === 'llm'\n        ? normalizedMode\n        : DEFAULT_MODE\n    return {\n      mode,\n      openAiKey: parsed.openAiKey,\n      chatModel: parsed.chatModel ?? DEFAULT_CHAT_MODEL,\n      parseModel: parsed.parseModel ?? parsed.chatModel ?? DEFAULT_PARSE_MODEL,\n      nutritionModel: parsed.nutritionModel ?? DEFAULT_NUTRITION_MODEL,\n      preferredWeightUnit: parsed.preferredWeightUnit ?? DEFAULT_WEIGHT_UNIT,\n      preferredDistanceUnit: parsed.preferredDistanceUnit ?? DEFAULT_DISTANCE_UNIT,\n    }\n  } catch {\n    return { ...DEFAULT_SETTINGS }\n  }\n}\n\nexport function saveSettings(settings: AssistantSettings) {\n  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings))\n  try {\n    window.dispatchEvent(new Event(ASSISTANT_SETTINGS_CHANGED_EVENT))\n  } catch {\n    // ignore\n  }\n}\n",
        "last_modified": "2026-01-13T12:35:11.832928"
      },
      "task_intent": {
        "title": "007-so-on-the-engine-right-here-where-i-chat-so-here-l",
        "description": "",
        "from_plan": false
      },
      "commits_behind_main": 3,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-13T12:35:11.261688",
  "last_updated": "2026-01-13T12:35:11.346181"
}