/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var m=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var N=Object.prototype.hasOwnProperty;var T=(c,l)=>{for(var t in l)m(c,t,{get:l[t],enumerable:!0})},V=(c,l,t,e)=>{if(l&&typeof l=="object"||typeof l=="function")for(let s of k(l))!N.call(c,s)&&s!==t&&m(c,s,{get:()=>l[s],enumerable:!(e=D(l,s))||e.enumerable});return c};var x=c=>V(m({},"__esModule",{value:!0}),c);var L={};T(L,{default:()=>d});module.exports=x(L);var i=require("obsidian"),P={ollamaURL:"http://localhost:11434",searchThreshold:.8,maxResults:10,chunkSize:500,chunkOverlap:100,chunkingStrategy:"paragraph",debounceTime:300,fileProcessingDebounceTime:2e3,modelName:"nomic-embed-text:latest",vectors:[]},d=class extends i.Plugin{constructor(){super(...arguments);this.vectorStore=new Map}async onload(){await this.loadSettings(),this.debouncedProcessFile=(0,i.debounce)(async e=>{await this.processFile(e)},this.settings.fileProcessingDebounceTime),this.registerEvent(this.app.vault.on("modify",async e=>{e instanceof i.TFile&&e.extension==="md"&&this.debouncedProcessFile(e)})),this.registerEvent(this.app.vault.on("rename",async(e,s)=>{e instanceof i.TFile&&e.extension==="md"&&(this.removeFileVectors(s),await this.debouncedProcessFile(e))})),this.registerEvent(this.app.vault.on("delete",e=>{e instanceof i.TFile&&e.extension==="md"&&(this.removeFileVectors(e.path),this.saveSettings())})),await this.checkRequirements()&&(this.addRibbonIcon("refresh-cw","Rebuild vector index",async()=>{await this.buildVectorIndex(),new i.Notice("Vector index rebuilt!")}),this.addCommand({id:"search-similar-notes",name:"Search similar notes",callback:()=>{new p(this.app,this).open()}}),this.addSettingTab(new v(this.app,this)))}async onunload(){}async loadSettings(){this.settings=Object.assign({},P,await this.loadData()),this.vectorStore=new Map(this.settings.vectors.map(t=>[t.path,t]))}async saveSettings(){await this.saveData(this.settings)}removeFileVectors(t){let e=(0,i.normalizePath)(t);for(let[s,a]of this.vectorStore.entries())a.path===e&&this.vectorStore.delete(s)}async processFile(t){try{let e=await this.app.vault.read(t),s=this.splitIntoChunks(e);this.removeFileVectors(t.path);for(let a=0;a<s.length;a++){let r=s[a],n=e.slice(0,e.indexOf(r)).split(`
`).length-1,o=n+r.split(`
`).length,u=await this.getEmbedding(r);if(!u||u.length===0)throw new Error("Failed to generate embedding");let h={path:(0,i.normalizePath)(t.path),embedding:u,title:`${t.basename} (chunk ${a+1}/${s.length})`,startLine:n,endLine:o},g=`${h.path}#${a}`;this.vectorStore.set(g,h)}this.settings.vectors=Array.from(this.vectorStore.values()),await this.saveSettings()}catch(e){console.error(`Failed to process file ${t.path}:`,e),new i.Notice(`Failed to process file: ${t.basename}`)}}compareVersions(t,e){let s=t.split("."),a=e.split(".");for(let r=0;r<3;r++){let n=Number(s[r]),o=Number(a[r]);if(n>o)return 1;if(o>n)return-1;if(!isNaN(n)&&isNaN(o))return 1;if(isNaN(n)&&!isNaN(o))return-1}return 0}async checkRequirements(){var t;try{if(!(await fetch(`${this.settings.ollamaURL}/api/version`,{method:"GET"})).ok)return new i.Notice("Could not connect to Ollama server. Please ensure Ollama is installed and running."),console.error("[Vector Search] Ollama connection failed"),!1;let s=await fetch(`${this.settings.ollamaURL}/api/tags`,{method:"GET"});return s.ok?((t=(await s.json()).models)==null?void 0:t.some(n=>n.name===this.settings.modelName))?!0:(new i.Notice(`Required model '${this.settings.modelName}' not found. Please run: ollama pull ${this.settings.modelName}`),console.error("[Vector Search] Required model not installed"),!1):(new i.Notice("Could not check available models. Please verify Ollama installation."),!1)}catch(e){return new i.Notice(`
                Vector Search Plugin Requirements Not Met:
                1. Install Ollama from ollama.ai
                2. Start Ollama service
                3. Run: ollama pull ${this.settings.modelName}
            `),console.error("[Vector Search] Requirements check failed:",e),!1}}async checkOllamaConnection(){try{return(await fetch(`${this.settings.ollamaURL}/api/embeddings`,{method:"HEAD"})).ok}catch(t){return new i.Notice("Could not connect to Ollama server. Please check your settings and ensure Ollama is running."),console.error("[Vector Search] Ollama connection error:",t),!1}}splitIntoChunks(t){if(this.settings.chunkSize===0)return[t];if(this.settings.chunkingStrategy==="paragraph"){let a=t.split(/\n\s*\n/),r=[],n="";for(let o of a)(n+o).length>this.settings.chunkSize?(n&&r.push(n.trim()),n=o):n=n?`${n}

${o}`:o;return n&&r.push(n.trim()),r}let e=[],s=0;for(;s<t.length;){let a=t.slice(s,s+this.settings.chunkSize);e.push(a),s+=this.settings.chunkSize-this.settings.chunkOverlap}return e}async getEmbedding(t){try{return(await(await fetch(`${this.settings.ollamaURL}/api/embeddings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:this.settings.modelName,prompt:t})})).json()).embedding}catch(e){return console.error("[Vector Search] Error getting embedding:",e),new i.Notice("Error getting embedding from Ollama"),[]}}cosineSimilarity(t,e){let s=t.reduce((n,o,u)=>n+o*e[u],0),a=Math.sqrt(t.reduce((n,o)=>n+o*o,0)),r=Math.sqrt(e.reduce((n,o)=>n+o*o,0));return s/(a*r)}async buildVectorIndex(){this.vectorStore.clear();let t=this.app.vault.getMarkdownFiles(),e=0,s=t.length,a=new i.Notice(`Indexing files: 0/${s} (0%)`,0);for(let r of t){let n=await this.app.vault.read(r),o=this.splitIntoChunks(n),u=n.split(`
`);for(let h=0;h<o.length;h++){let g=o[h],f=n.slice(0,n.indexOf(g)).split(`
`).length-1,b=f+g.split(`
`).length,S=await this.getEmbedding(g),y={path:(0,i.normalizePath)(r.path),embedding:S,title:`${r.basename} (chunk ${h+1}/${o.length})`,startLine:f,endLine:b},w=`${y.path}#${h}`;this.vectorStore.set(w,y)}e++,a.setMessage(`Indexing files: ${e}/${s} (${Math.round(e/s*100)}%)`)}this.settings.vectors=Array.from(this.vectorStore.values()),await this.saveSettings(),a.hide(),new i.Notice("Vector index rebuilt successfully!")}},p=class extends i.Modal{constructor(t,e){super(t);this.plugin=e}onOpen(){let{contentEl:t}=this;t.empty();let e=t.createDiv("search-container");this.searchInput=e.createEl("input",{type:"text",placeholder:"Type to search similar notes..."}),this.resultsDiv=t.createDiv("search-results");let s=(0,i.debounce)(async()=>{let a=this.searchInput.value;if(a.length<3){this.resultsDiv.empty();return}await this.performSearch(a)},this.plugin.settings.debounceTime,!0);this.searchInput.addEventListener("input",s),this.searchInput.focus()}async performSearch(t){if(this.plugin.vectorStore.size===0){this.resultsDiv.setText("Vector index is empty. Please rebuild the index first.");return}let e=await this.plugin.getEmbedding(t),s=[];for(let a of this.plugin.vectorStore.values()){let r=this.plugin.cosineSimilarity(e,a.embedding);r>=this.plugin.settings.searchThreshold&&s.push({vectorData:a,similarity:r})}s.sort((a,r)=>r.similarity-a.similarity),this.displayResults(s.slice(0,this.plugin.settings.maxResults))}displayResults(t){if(this.resultsDiv.empty(),t.length===0){this.resultsDiv.setText("No similar notes found");return}let e=this.resultsDiv.createEl("ul");for(let s of t){let a=e.createEl("li"),r=a.createEl("a",{text:`${s.vectorData.title} (${(s.similarity*100).toFixed(2)}%)`,href:"#"});a.createEl("div",{text:`Lines ${s.vectorData.startLine}-${s.vectorData.endLine}`,cls:"search-result-lines"}),r.addEventListener("click",async n=>{n.preventDefault();let o=this.app.vault.getAbstractFileByPath(s.vectorData.path);o instanceof i.TFile&&(await this.app.workspace.getLeaf().openFile(o),this.close())})}}onClose(){let{contentEl:t}=this;t.empty()}},v=class extends i.PluginSettingTab{constructor(t,e){super(t,e);this.plugin=e}display(){let{containerEl:t}=this;t.empty(),new i.Setting(t).setName("Server configuration").setHeading(),new i.Setting(t).setName("Ollama URL").setDesc("URL of your Ollama server").addText(e=>e.setPlaceholder("http://localhost:11434").setValue(this.plugin.settings.ollamaURL).onChange(async s=>{this.plugin.settings.ollamaURL=s,await this.plugin.saveSettings()})),new i.Setting(t).setName("Model name").setDesc("Name of the embedding model to use").addText(e=>e.setPlaceholder("nomic-embed-text:latest").setValue(this.plugin.settings.modelName).onChange(async s=>{this.plugin.settings.modelName=s,await this.plugin.saveSettings()})),new i.Setting(t).setName("Search options").setHeading(),new i.Setting(t).setName("Search threshold").setDesc("Minimum similarity score (0-1) for showing results").addSlider(e=>e.setLimits(0,1,.05).setValue(this.plugin.settings.searchThreshold).setDynamicTooltip().onChange(async s=>{this.plugin.settings.searchThreshold=s,await this.plugin.saveSettings()})),new i.Setting(t).setName("Maximum results").setDesc("Maximum number of search results to display").addSlider(e=>e.setLimits(1,50,1).setValue(this.plugin.settings.maxResults).setDynamicTooltip().onChange(async s=>{this.plugin.settings.maxResults=s,await this.plugin.saveSettings()})),new i.Setting(t).setName("Debounce time").setDesc("Delay in milliseconds before searching after typing").addSlider(e=>e.setLimits(100,1e3,50).setValue(this.plugin.settings.debounceTime).setDynamicTooltip().onChange(async s=>{this.plugin.settings.debounceTime=s,await this.plugin.saveSettings()})),new i.Setting(t).setName("File processing delay").setDesc("Delay in milliseconds before processing file changes").addSlider(e=>e.setLimits(500,5e3,500).setValue(this.plugin.settings.fileProcessingDebounceTime).setDynamicTooltip().onChange(async s=>{this.plugin.settings.fileProcessingDebounceTime=s,await this.plugin.saveSettings()})),new i.Setting(t).setName("Chunking options").setHeading(),new i.Setting(t).setName("Chunk size").setDesc("Number of characters per text chunk (0 for no chunking)").addSlider(e=>e.setLimits(0,2e3,100).setValue(this.plugin.settings.chunkSize).setDynamicTooltip().onChange(async s=>{this.plugin.settings.chunkSize=s,await this.plugin.saveSettings()})),new i.Setting(t).setName("Chunking strategy").setDesc("How to split documents into chunks").addDropdown(e=>e.addOption("character","Character-based").addOption("paragraph","Paragraph-based").setValue(this.plugin.settings.chunkingStrategy).onChange(async s=>{this.plugin.settings.chunkingStrategy=s,await this.plugin.saveSettings()})),new i.Setting(t).setName("Chunk overlap").setDesc("Number of characters to overlap between chunks").addSlider(e=>e.setLimits(0,200,10).setValue(this.plugin.settings.chunkOverlap).setDynamicTooltip().onChange(async s=>{this.plugin.settings.chunkOverlap=s,await this.plugin.saveSettings()}))}};

/* nosourcemap */